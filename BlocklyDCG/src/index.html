<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>

        <!-- blockly scripts -->
        <script src="blockly/blockly_uncompressed.js"></script>

        <!-- generator script -->
        <script src="blockly/generators/dcg.js"></script>

        <!-- blockly language -->
        <script src="blockly/msg/js/nl.js"></script>
        <script src="blockly/blocks/eval.js"></script>
        <script src="blockly/blocks/comment.js"></script>

        <script src="blockly/blocks/logic.js"></script>
        <script src="blockly/blocks/loops.js"></script>
        <script src="blockly/blocks/math.js"></script>
        <script src="blockly/blocks/text.js"></script>
        <script src="blockly/blocks/lists.js"></script>
        <script src="blockly/blocks/variables.js"></script>
        <script src="blockly/blocks/procedures.js"></script>
        <script src="blockly/blocks/html.js"></script>
        <script src="blockly/blocks/lists.js"></script>


        <!-- python examples -->
        <script src="blockly/generators/python/text.js"></script>
        <script src="blockly/generators/python/variables.js"></script>


        <!-- dcg examples -->
        <script src="blockly/generators/dcg/text.js"></script>
        <script src="blockly/generators/dcg/variables.js"></script>
        <script src="blockly/generators/dcg/eval.js"></script>
        <script src="blockly/generators/dcg/logic.js"></script>
        <script src="blockly/generators/dcg/comment.js"></script>
        <script src="blockly/generators/dcg/html.js"></script>
        <script src="blockly/generators/dcg/lists.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js"></script>

        <style>
            html, body {
                height: 100%;
                margin: 0;
            }
            body {
                font-family: sans-serif;
                overflow: hidden;
            }
            h1 {
                font-weight: normal;
                font-size: 140%;
            }
            table {
                background-color: #fdf6e3;
                height: 100%;
                width: 100%;
            }
            #blocklyArea {
                height: 99%;
            }

            #ruletext{
                width: 100%;
                height: 100%;
                background-color: #002b36;
                color: #93a1a1 ;
                font-size: 24px;
            }
        </style>

    </head>
    <body>



        <!-- Add your site or application content here -->
        <!--<p>DCG editor</p>-->

        <table>
            <tr>
                <td>
                    <h1> DCG Editor met <a href="https://developers.google.com/blockly/"> BlockLy </a> PoC </h1>
                    <a href="dcgtoblockly.html">DCG to blockly</a>
                <button onclick="saveWorkspace()"> Save </button>
                <button onclick="loadFromXML()"> Load </button>
            </tr>
            <tr>
                <td id="blocklyArea" style="width: 60%">
                </td>
                <td id="editorArea" style="width: 40%; height:100%">
                    <div id="editorAreaDiv" style="width: 100%; height: 50%">
                        <textarea id="ruletext">
                        </textarea>
                    </div>
                    <div id="htmlPreviewDiv" style="width: 100%; height:50%; background-color: #99c0ff; font-size: 20px;">

                    </div>
                </td>
            </tr>
        </table>

        <div id="blocklyDiv" style="position: absolute"></div>

        <xml id="toolbox" style="display: none">

            <category name="Logica">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
            </category>
            <!--<block type="logic_compare"></block>-->
            <!--<block type="controls_repeat_ext"></block>-->
            <!-- <block type="math_number"></block> -->
            <!--<block type="math_arithmetic"></block>-->
            <category name="Text">
                <block type="text"></block>
                <block type="text_append"></block>
                <block type="text_print"></block>
                <block type="text_isEmpty"></block>
            </category>

            <category name="Varia">
                <block type="eval"></block>
                <block type="singleComment"></block>
                <block type="lists_create_with"></block>
            </category>

            <category name="Variabelen">
                <block type="variables_set"></block>
                <block type="variables_get"></block>
            </category>

            <category name="HTML"> <!-- todo: rename to layout or something similar -->
                <block type="html_start"></block>
                <block type="html_bold"></block>
                <block type="html_italic"></block>
                <block type="html_underline"></block>
                <block type="html_break"></block>
            </category>

            <!--<block type="procedures_defnoreturn"></block>-->
        </xml>


        <script>
            var blocklyArea = document.getElementById('blocklyArea');
            var blocklyDiv = document.getElementById('blocklyDiv');
            var workspace = Blockly.inject(blocklyDiv,
                {media: 'blockly/media/',
                    toolbox: document.getElementById('toolbox')});
            var onresize = function(e) {
                // Compute the absolute coordinates and dimensions of blocklyArea.
                var element = blocklyArea;
                var x = 0;
                var y = 0;
                do {
                    x += element.offsetLeft;
                    y += element.offsetTop;
                    element = element.offsetParent;
                } while (element);
                // Position blocklyDiv over blocklyArea.
                blocklyDiv.style.left = x + 'px';
                blocklyDiv.style.top = y + 'px';
                blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
                blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
            };
            window.addEventListener('resize', onresize, false);
            onresize();
            Blockly.svgResize(workspace);

            function generateCode() {
                var code = "rule TESTRULE{\n"
                code += Blockly.Dcg.workspaceToCode(workspace);
                code += "\n}"
                document.getElementById('ruletext').innerHTML = code;
            }
            setInterval(generateCode, 100);

            function generatePreview(){
                var code = Blockly.Dcg.workspaceToCode(workspace);
                // get the CODE that is HTML.
                var result = code.match("<html>.*<\\/html>")[0]; // first assume there is only one matching element.
                result = result.substring("<html>".length,result.length - "</html>".length);
                var previewDiv = document.getElementById("htmlPreviewDiv");
                previewDiv.innerHTML = result;
//                var parser = new DOMParser();
//                console.log(result);
//                var doc = parser.parseFromString(result,"text/html");
            }
            setInterval(generatePreview, 100);


            function saveWorkspace(){
                var xml = Blockly.Xml.workspaceToDom(workspace);
                var xmlText = Blockly.Xml.domToText(xml);
                console.log(xmlText);
            }

            function loadFromXML(){
                var xml = prompt("xml");
                var dom = Blockly.Xml.textToDom(xml);
                Blockly.mainWorkspace.clear();
                Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, dom);
            }
        </script>

    </body>
</html>
